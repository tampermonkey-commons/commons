class Logger{constructor(e="logger"){this.version="0.5.0",this.name=e}getTime(){var e=new Date;let t=e.getHours()+"",s=(1==t.length&&(t="0"+t),e.getMinutes()+""),n=(1==s.length&&(s="0"+s),e.getSeconds()+""),i=(1==n.length&&(n="0"+n),e.getMilliseconds()+"");return 1==i.length?i="00"+i:2==i.length&&(i="0"+i),`${t}:${s}:${n}.`+i}debug(e,...t){this.log(console.debug,"DEBUG",e,...t)}info(e,...t){this.log(console.info,"INFO",e,...t)}warn(e,...t){this.log(console.warn,"WARN",e,...t)}error(e,...t){this.log(console.error,"ERROR",e,...t)}log(e,t,s,...n){s="%s [%s] %s "+s;null!=n&&0<n.length?e(s,this.getTime(),this.name,t,...n):e(s,this.getTime(),this.name,t)}}class UserScriptConfig{constructor(e="user-script-config"){this.name=e,this.version="0.5.0",this.logger=new Logger(e)}listValues(){return GM_listValues()}containsKey(e){return null!=this.getValue(e,void 0)}getValue(e,t){return GM_getValue(e,t)}setValue(e,t){return GM_setValue(e,t)}getOrInitValue(e,t){let s=this.getValue(e,void 0);return null==s&&(s=t,this.setValue(e,t)),s}deleteValue(e){GM_deleteValue(e)}}class DynamicInjector{constructor(){this.version="0.5.0",this.defaultCDN="https://cdn.jsdelivr.net/npm/",this.logger=new Logger("dynamic-injector")}sleep=t=>new Promise(e=>setTimeout(e,t));getFileExtName(e){var e=new URL(e).pathname,t=e.lastIndexOf(".");return e.substring(t)}async dynamicInjectByUrl(e,t=5e3,s=void 0){var n=this.getFileExtName(e);if(".js"!=n)return".css"==n?((n=document.createElement("link")).href=e,n.rel="stylesheet",document.head.appendChild(n),!0):(this.logger.warn("未识别的资源类型：%s",e),!1);(n=document.createElement("script")).src=e,document.body.appendChild(n);let i=!1;var r,o=new Date;do{if(t<=(new Date).getTime()-o.getTime())return this.logger.warn("动态加载 %s 超时",e),!1;if(await this.sleep(10),null!=s){if(i=s())return r=(new Date).getTime()-o.getTime(),this.logger.debug("动态加载 %s 成功，耗时：%d ms",e,r),!0}else i=!0}while(!i);return i}async dynamicInjectFromCDN(e,t,s,n,i=5e3,r=void 0){let o=t;null!=s&&0<s.length&&(o+="@"+s);t=""+e+o+n;return this.dynamicInjectByUrl(t,i,r)}async dynamicInject(e,t,s,n=5e3,i=void 0){return this.dynamicInjectFromCDN(this.defaultCDN,e,t,s,n,i)}}class Skeleton{constructor(e){this.name=(e.hasOwnProperty("name")?e:GM_info.script).name,this.version=(e.hasOwnProperty("version")?e:GM_info.script).version,this.optionsUrl=e.hasOwnProperty("url")?e.url:null,this.logger=new Logger(this.name),this.injector=new DynamicInjector,this.appNodeId=null,this.injectStyles=null,this.vueVersion=e.hasOwnProperty("vue")?e.vue:null,this.vue=null,this.vueOptions=null,this.vueApp=null,this.elementVersion=e.hasOwnProperty("element")?e.element:null,this.element=null,this.vuexVersion=e.hasOwnProperty("vuex")?e.vuex:null,this.vuex=null,this.storeOptions=null}async dynamicInjectVue(){let e=!1,t=this;if(null!=this.vueVersion&&!(e=await this.injector.dynamicInject("vue",this.vueVersion,"/dist/vue.global.prod.js",5e3,()=>{if("undefined"!=typeof Vue)return t.vue=Vue,t.logger.info("Vue %s Loaded.",t.vue.version),!0})))return e;if(null!=this.elementVersion){if(!(e=await this.injector.dynamicInject("element-plus",this.elementVersion,"/dist/index.full.min.js",5e3,()=>{if("undefined"!=typeof ElementPlus)return t.element=ElementPlus,t.logger.info("Element Plus %s Loaded.",t.element.version),!0})))return e;this.injector.dynamicInject("element-plus",this.elementVersion,"/dist/index.min.css")}return!(null!=this.vuexVersion&&!(e=await this.injector.dynamicInject("vuex",this.vuexVersion,"/dist/vuex.global.min.js",5e3,()=>{if("undefined"!=typeof Vuex)return t.vuex=Vuex,t.logger.info("Vuex %s Loaded.",t.vuex.version),!0})))||e}async dynamicInjectOptions(e,s=void 0){if(null==s){let t=this;s=()=>{let e=0;return"undefined"!=typeof appNodeId&&(t.appNodeId=appNodeId,e++),"undefined"!=typeof vueAppOptions&&(t.vueOptions=vueAppOptions,e++),"undefined"!=typeof storeOptions&&(t.storeOptions=storeOptions,e++),"undefined"!=typeof injectStyles&&(t.injectStyles=injectStyles,e++),0<e}}return await this.injector.dynamicInjectByUrl(e,5e3,s)}async createVueApp(e){var t;return!!await this.dynamicInjectVue()&&!!await this.dynamicInjectOptions(e)&&(null==(e=document.getElementById(this.appNodeId))&&((e=document.createElement("div")).id=this.appNodeId,document.body.appendChild(e)),e=this.vue.createApp(this.vueOptions),null!=this.element&&e.use(this.element),null!=this.storeOptions&&(t=this.vuex.createStore(this.storeOptions),e.use(t)),e.mount("#"+this.appNodeId),this.vueApp=e,!0)}async start(){this.createVueApp(this.optionsUrl)}}class JsonRpcRequest{constructor(e,t,s){this.jsonrpc="2.0",this.method=e,this.params=t,this.id=s}}class JsonRpcResponse{constructor(e,t){this.jsonrpc="2.0",this.result=e,this.error=null,this.id=t}}class JsonRpcWebSocketClient{constructor(e,t){this.version="0.6.0",this.name=e,this.url=t,this.webSocket=null,this.logger=new Logger("jsonrpc-wsc"),this.status="disconnected"}sleep=t=>new Promise(e=>setTimeout(e,t));async createWebSocket(e=null){null==e&&(e=this.url);let t=this;for(e=new WebSocket(e),e.addEventListener("open",e=>{t.onOpen(e)}),e.addEventListener("message",e=>{t.onMessage(e.data,e.origin,e.lastEventId,e.source,e.ports)}),e.addEventListener("close",e=>{t.onClose(e.code,e.reason,e.wasClean)}),e.addEventListener("error",e=>{t.onError(e)}),this.webSocket=e,e=new Date;await this.sleep(10),"connected"!=this.status;);return(new Date).getTime()-e.getTime()}onOpen(e){this.logger.info("与服务端 %s 连接已建立："+e,this.name),this.status="connected"}onMessage(e,t,s,n,i){this.logger.info("写收到来自服务端 %s 的报文 %s",this.name,e)}onClose(e,t,s){this.logger.info("与服务端 %s 连接断开，code=%d reason=%s",this.name,e,t)}onError(e){this.logger.info("与服务端 %s 通信发生错误："+e,this.name)}}class Aria2Client extends JsonRpcWebSocketClient{constructor(e,t,s=null){super("aria2-client",t),this.token=s,this.requests=new Map,this.eventTarget=new EventTarget}createParams(e=!0){let t=null;null!=this.token&&""!=this.token&&(t="token:"+this.token);var s=[];return e&&null!=t&&s.push(t),s}generateId(){return crypto.randomUUID()}send(e,t,s=null){null==s&&(s=this.generateId());e=new JsonRpcRequest(e,t,s);this.requests.set(s,e),this.webSocket.send(JSON.stringify(e))}getVersion(){var e=this.createParams(!0);this.send("aria2.getVersion",e)}addUri(e,t={},s=null){var n=this.createParams(!0);if("string"==typeof e)n.push([e]);else{if(!Array.isArray(e))return void this.logger.warn("无效的请求参数：uris不是字符串也不是字符串数组");n.push(e)}n.push(t),null!=s&&n.push(s),this.send("aria2.addUri",n)}addUriWithOptions(e,t,s,n,i=null){var r={};null!=t&&(r.dir=t),null!=s&&(r.out=s),null!=n&&(r["all-proxy"]=n),this.addUri(e,r,i)}tellStatus(e,t=null){var s=this.createParams(!0);s.push(e),null!=t&&s.push(t),this.send("aria2.tellStatus",s)}tellStatusWithDefaultKeys(e){this.tellStatus(e,["gid","status","totalLength","completedLength"])}onMessage(e,t,s,n,i){var r=JSON.parse(e);let o=!1;do{if(!r.hasOwnProperty("jsonrpc")){this.logger.warn("缺少字段jsonrpc，不是JSON-RPC报文"),o=!0;break}if("2.0"!=r.jsonrpc){this.logger.warn("JSON-RPC协议版本不是2.0"),o=!0;break}}while(r.hasOwnProperty("method")?this.onRequest(r):r.hasOwnProperty("id")||r.hasOwnProperty("result")||r.hasOwnProperty("error")?this.onResponse(r):(this.logger.warn("未找到id、result、error等字段"),o=!0),0);o&&this.logger.debug("写收到来自服务端 %s 的无效报文："+r,this.name)}onRequest(e){this.logger.debug("接收到请求报文："+e)}onResponse(e){this.logger.debug("接收到响应报文："+e),this.requests.has(e.id)&&(e=this.requests.get(e.id),this.logger.debug("对应的请求报文："+e))}}